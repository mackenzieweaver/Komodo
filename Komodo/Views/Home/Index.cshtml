@model Komodo.Models.ViewModels.HomePMViewModel
@inject Komodo.Services.IBTRolesService _rolesService
@inject Microsoft.AspNetCore.Identity.UserManager<BTUser> _userManager
@inject Komodo.Services.IBTProjectService _projectService


@{
    ViewData["Title"] = "Dashboard";
    var user = await _userManager.GetUserAsync(User);
    var roles = await _rolesService.ListUserRoles(user);
    string roleName = "";
    foreach (var role in roles)
    {
        if (role != "Demo")
        {
            roleName = role;
        }
    }

    var num = 5;
    var tCount = Model.Developers.Count;
    num = tCount < num ? tCount : num;
}

<div class="row justify-content-center">
    <div class="col-md-12">
        <div>
            <h1>Welcome back, @user.FirstName</h1>
            <h4>Role --> <u>@roleName</u></h4>
        </div>

        <div class="row mt-5 mb-5 ml-1 mr-1">
            <div class="col-md-12 p-5 widget">
                <div class="widget-heading">
                    <h3 class="mb-4">Quick ticket overview</h3>
                </div>
                <div class="row">
                    <div class="col-xl-3 col-md-6">
                        <div class="card text-white mb-1" style="background-color: #5c1ac3">
                            <div class="card-body">Total tickets (@Model.numTickets)</div>
                            <div class="card-footer d-flex align-items-center justify-content-between">
                                <a class="small text-white stretched-link" asp-controller="Tickets" asp-action="Filter">View Details</a>
                                <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <div class="card bg-warning mb-1">
                            <div class="card-body">Unassigned tickets (@Model.numUnassigned)</div>
                            <div class="card-footer d-flex align-items-center justify-content-between">
                                <a class="small stretched-link" asp-controller="Tickets" asp-action="Filter" asp-route-filter="Unassigned">View Details</a>
                                <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <div class="card mb-1" style="background-color: #009688">
                            <div class="card-body text-white">New tickets (@Model.numOpen)</div>
                            <div class="card-footer d-flex align-items-center justify-content-between">
                                <a class="small stretched-link" asp-controller="Tickets" asp-action="Filter" asp-route-filter="Open">View Details</a>
                                <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <div class="card bg-danger text-white mb-1">
                            <div class="card-body">Urgent tickets (@Model.numCritical)</div>
                            <div class="card-footer d-flex align-items-center justify-content-between">
                                <a class="small text-white stretched-link" asp-controller="Tickets" asp-action="Filter" asp-route-filter="Critical">View Details</a>
                                <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        @if (User.IsInRole("ProjectManager"))
        {
            @* Suggested Action *@
            <div class="row mt-5 mb-5 ml-1 mr-1">
                <div class="col-md-12 p-5 widget">
                    <h5 class="mb-4">Suggested Actions</h5>
                    <table class="table table-striped table-responsive-md ticketsIndex">
                        <thead>
                            <tr>
                                <th>
                                    Developer
                                </th>
                                <th>
                                    #Tasks
                                </th>
                                <th>
                                    Ticket
                                </th>
                                <th>
                                    Priority
                                </th>
                                <th>
                                    Type
                                </th>
                                <th>
                                    Status
                                </th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (var i = 0; i < num; i++)
                            {
                                <tr>
                                    <td>
                                        @Model.Developers[i].FullName
                                    </td>
                                    <td>
                                        @Model.Count[i]
                                    </td>
                                    <td>
                                        @Model.Tickets[i].Title
                                    </td>
                                    <td>
                                        @Model.Tickets[i].TicketPriority.Name
                                    </td>
                                    <td>
                                        @Model.Tickets[i].TicketType.Name
                                    </td>
                                    <td>
                                        @Model.Tickets[i].TicketStatus.Name
                                    </td>
                                    <td>
                                        <form asp-controller="Tickets" asp-action="Edit">
                                            <input type="hidden" name="Id" value="@Model.Tickets[i].Id" />
                                            <input type="hidden" name="Title" value="@Model.Tickets[i].Title" />
                                            <input type="hidden" name="Description" value="@Model.Tickets[i].Description" />
                                            <input type="hidden" name="Created" value="@Model.Tickets[i].Created" />
                                            <input type="hidden" name="Updated" value="@DateTime.Now" />
                                            <input type="hidden" name="ProjectId" value="@Model.Tickets[i].ProjectId" />
                                            <input type="hidden" name="TicketTypeId" value="@Model.Tickets[i].TicketTypeId" />
                                            <input type="hidden" name="TicketPriorityId" value="@Model.Tickets[i].TicketPriorityId" />
                                            <input type="hidden" name="TicketStatusId" value="@Model.Tickets[i].TicketStatusId" />
                                            <input type="hidden" name="OwnerUserId" value="@Model.Tickets[i].OwnerUserId" />
                                            <input type="hidden" name="DeveloperUserId" value="@Model.Developers[i].Id" />
                                            <input type="submit" value="Assign" class="btn btn-light" />
                                        </form>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="row">
                @* Bar Chart *@
                <div class="col">
                    <div class="widget widget-chart-two p-5">
                        <div class="widget-heading">
                            <h5 class="mb-4">Developers</h5>
                        </div>
                        <div class="widget-content">
                            <div id="bar-chart" class=""></div>
                        </div>
                    </div>
                </div>
            </div>
        }

        @if (User.IsInRole("Admin") || User.IsInRole("ProjectManager"))
        {
            <div class="row mt-3">
                @* Donut Chart *@
                <div id="userbasedonut" class="col-md">
                    <div class="widget widget-chart-two p-5">
                        <div class="widget-heading">
                            <h5 class="mb-4">Types of Users</h5>
                        </div>
                        <div class="widget-content">
                            <div id="donut-chart" class=""></div>
                        </div>
                    </div>
                </div>
                <div class="col-md">
                    <div class="row mr-1">
                        <div class="col p-5 widget">
                            <div class="widget-heading">
                                <h5 class="mb-4">Individual Users</h5>
                            </div>
                            <div class="widget-content">
                                <table class="table table-striped table-responsive-md ticketsIndex">
                                    <thead>
                                        <tr>
                                            <th>
                                                Name
                                            </th>
                                            <th>
                                                Role
                                            </th>
                                            <th>
                                                Email
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var u in Model.UsersOnProject)
                                        {
                                            <tr>
                                                <td>
                                                    @u.FullName
                                                </td>
                                                <td>
                                                    @foreach (var role in await _rolesService.ListUserRoles(u))
                                                    {
                                                        @role
                                                    }
                                                </td>
                                                <td>
                                                    @u.Email
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

        @if (User.IsInRole("Developer"))
        {
            <div class="row ml-1 mr-1 mb-5">
                <div class="col-md widget p-5">
                    <div class="widget-heading">
                        <h3 class="mb-4">All Tickets</h3>
                    </div>
                    <table class="table table-striped table-responsive ticketsIndex">
                        <thead>

                            <tr>
                                <th>
                                    Title
                                </th>
                                <th>
                                    Description
                                </th>
                                <th>
                                    Created
                                </th>
                                <th>
                                    Updated
                                </th>
                                <th>
                                    Project
                                </th>
                                <th>
                                    Type
                                </th>
                                <th>
                                    Priority
                                </th>
                                <th>
                                    Status
                                </th>
                                <th>
                                    Creator
                                </th>
                                <th>
                                    Developer
                                </th>
                                <th>
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var ticket in Model.Tickets)
                            {
                                <tr>
                                    <td>
                                        @ticket.Title
                                    </td>
                                    <td>
                                        @Html.Raw(ticket.Description)
                                    </td>
                                    <td>
                                        @ticket.Created
                                    </td>
                                    <td>
                                        @ticket.Updated
                                    </td>
                                    <td>
                                        @ticket.Project.Name
                                    </td>
                                    <td>
                                        @ticket.TicketType.Name
                                    </td>
                                    <td>
                                        @ticket.TicketPriority.Name
                                    </td>
                                    <td>
                                        @ticket.TicketStatus.Name
                                    </td>
                                    <td>
                                        @ticket.OwnerUser.FullName
                                    </td>
                                    <td>
                                        @if (ticket.DeveloperUserId == null)
                                        {
                                            <p>Unassigned</p>
                                        }
                                        else
                                        {
                                            @Html.DisplayFor(modelItem => ticket.DeveloperUser.FullName)
                                        }
                                    </td>
                                    <td>
                                        <a asp-controller="Tickets" asp-action="Details" asp-route-id="@ticket.Id" class="btn btn-outline-dark text-white">Details</a>
                                        @if (User.IsInRole("Admin") ||
                                  User.IsInRole("ProjectManager") && await _projectService.IsUserOnProject(user.Id, ticket.ProjectId) ||
                                  User.IsInRole("Developer") && ticket.DeveloperUserId == user.Id ||
                                  User.IsInRole("Submitter") && ticket.OwnerUserId == user.Id)
                                        {
                                            <a asp-controller="Tickets" asp-action="Edit" asp-route-id="@ticket.Id" class="btn btn-outline-dark text-white">Edit</a>}
                                        @if (User.IsInRole("Admin"))
                                        {
                                            <a asp-controller="Tickets" asp-action="Delete" asp-route-id="@ticket.Id" class="btn btn-outline-dark text-white">Delete</a>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="row ml-1 mr-1 mb-5">
                <div class="col-md widget p-5">
                    <div class="widget-heading">
                        <h3 class="mb-4">Tickets on your projects</h3>
                    </div>
                    <table class="table table-striped table-responsive ticketsIndex">
                        <thead>

                            <tr>
                                <th>
                                    Title
                                </th>
                                <th>
                                    Description
                                </th>
                                <th>
                                    Created
                                </th>
                                <th>
                                    Updated
                                </th>
                                <th>
                                    Project
                                </th>
                                <th>
                                    Type
                                </th>
                                <th>
                                    Priority
                                </th>
                                <th>
                                    Status
                                </th>
                                <th>
                                    Creator
                                </th>
                                <th>
                                    Developer
                                </th>
                                <th>
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var ticket in Model.TicketsOnDevProjs)
                            {
                                <tr>
                                    <td>
                                        @ticket.Title
                                    </td>
                                    <td>
                                        @Html.Raw(ticket.Description)
                                    </td>
                                    <td>
                                        @ticket.Created
                                    </td>
                                    <td>
                                        @ticket.Updated
                                    </td>
                                    <td>
                                        @ticket.Project.Name
                                    </td>
                                    <td>
                                        @ticket.TicketType.Name
                                    </td>
                                    <td>
                                        @ticket.TicketPriority.Name
                                    </td>
                                    <td>
                                        @ticket.TicketStatus.Name
                                    </td>
                                    <td>
                                        @ticket.OwnerUser.FullName
                                    </td>
                                    <td>
                                        @if (ticket.DeveloperUserId == null)
                                        {
                                            <p>Unassigned</p>
                                        }
                                        else
                                        {
                                            @Html.DisplayFor(modelItem => ticket.DeveloperUser.FullName)
                                        }
                                    </td>
                                    <td>
                                        <a asp-controller="Tickets" asp-action="Details" asp-route-id="@ticket.Id" class="btn btn-outline-dark text-white">Details</a>
                                        @if (User.IsInRole("Admin") ||
                                  User.IsInRole("ProjectManager") && await _projectService.IsUserOnProject(user.Id, ticket.ProjectId) ||
                                  User.IsInRole("Developer") && ticket.DeveloperUserId == user.Id ||
                                  User.IsInRole("Submitter") && ticket.OwnerUserId == user.Id)
                                        {
                                            <a asp-controller="Tickets" asp-action="Edit" asp-route-id="@ticket.Id" class="btn btn-outline-dark text-white">Edit</a>}
                                        @if (User.IsInRole("Admin"))
                                        {
                                            <a asp-controller="Tickets" asp-action="Delete" asp-route-id="@ticket.Id" class="btn btn-outline-dark text-white">Delete</a>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="row ml-1 mr-1">
                <div class="col-md widget p-5">
                    <div class="widget-heading">
                        <h3 class="mb-4">Assigned to you</h3>
                    </div>
                    <table class="table table-striped table-responsive ticketsIndex">
                        <thead>

                            <tr>
                                <th>
                                    Title
                                </th>
                                <th>
                                    Description
                                </th>
                                <th>
                                    Created
                                </th>
                                <th>
                                    Updated
                                </th>
                                <th>
                                    Project
                                </th>
                                <th>
                                    Type
                                </th>
                                <th>
                                    Priority
                                </th>
                                <th>
                                    Status
                                </th>
                                <th>
                                    Creator
                                </th>
                                <th>
                                    Developer
                                </th>
                                <th>
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var ticket in Model.TicketsAssignedToDev)
                            {
                                <tr>
                                    <td>
                                        @ticket.Title
                                    </td>
                                    <td>
                                        @Html.Raw(ticket.Description)
                                    </td>
                                    <td>
                                        @ticket.Created
                                    </td>
                                    <td>
                                        @ticket.Updated
                                    </td>
                                    <td>
                                        @ticket.Project.Name
                                    </td>
                                    <td>
                                        @ticket.TicketType.Name
                                    </td>
                                    <td>
                                        @ticket.TicketPriority.Name
                                    </td>
                                    <td>
                                        @ticket.TicketStatus.Name
                                    </td>
                                    <td>
                                        @ticket.OwnerUser.FullName
                                    </td>
                                    <td>
                                        @if (ticket.DeveloperUserId == null)
                                        {
                                            <p>Unassigned</p>
                                        }
                                        else
                                        {
                                            @Html.DisplayFor(modelItem => ticket.DeveloperUser.FullName)
                                        }
                                    </td>
                                    <td>
                                        <a asp-controller="Tickets" asp-action="Details" asp-route-id="@ticket.Id" class="btn btn-outline-dark text-white">Details</a>
                                        @if (User.IsInRole("Admin") ||
                                   User.IsInRole("ProjectManager") && await _projectService.IsUserOnProject(user.Id, ticket.ProjectId) ||
                                   User.IsInRole("Developer") && ticket.DeveloperUserId == user.Id ||
                                   User.IsInRole("Submitter") && ticket.OwnerUserId == user.Id)
                                        {
                                            <a asp-controller="Tickets" asp-action="Edit" asp-route-id="@ticket.Id" class="btn btn-outline-dark text-white">Edit</a>}
                                        @if (User.IsInRole("Admin"))
                                        {
                                            <a asp-controller="Tickets" asp-action="Delete" asp-route-id="@ticket.Id" class="btn btn-outline-dark text-white">Delete</a>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }

        @if (User.IsInRole("Submitter"))
        {
            <div class="row ml-1 mr-1 mb-5">
                <div class="col-md widget p-5">
                    <div class="widget-heading">
                        <h3 class="mb-4">All Tickets</h3>
                    </div>
                    <table class="table table-striped table-responsive ticketsIndex">
                        <thead>

                            <tr>
                                <th>
                                    Title
                                </th>
                                <th>
                                    Description
                                </th>
                                <th>
                                    Created
                                </th>
                                <th>
                                    Updated
                                </th>
                                <th>
                                    Project
                                </th>
                                <th>
                                    Type
                                </th>
                                <th>
                                    Priority
                                </th>
                                <th>
                                    Status
                                </th>
                                <th>
                                    Creator
                                </th>
                                <th>
                                    Developer
                                </th>
                                <th>
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var ticket in Model.Tickets)
                            {
                                <tr>
                                    <td>
                                        @ticket.Title
                                    </td>
                                    <td>
                                        @Html.Raw(ticket.Description)
                                    </td>
                                    <td>
                                        @ticket.Created
                                    </td>
                                    <td>
                                        @ticket.Updated
                                    </td>
                                    <td>
                                        @ticket.Project.Name
                                    </td>
                                    <td>
                                        @ticket.TicketType.Name
                                    </td>
                                    <td>
                                        @ticket.TicketPriority.Name
                                    </td>
                                    <td>
                                        @ticket.TicketStatus.Name
                                    </td>
                                    <td>
                                        @ticket.OwnerUser.FullName
                                    </td>
                                    <td>
                                        @if (ticket.DeveloperUserId == null)
                                        {
                                            <p>Unassigned</p>
                                        }
                                        else
                                        {
                                            @Html.DisplayFor(modelItem => ticket.DeveloperUser.FullName)
                                        }
                                    </td>
                                    <td>
                                        <a asp-controller="Tickets" asp-action="Details" asp-route-id="@ticket.Id" class="btn btn-outline-dark text-white">Details</a>
                                        @if (User.IsInRole("Admin") ||
                                  User.IsInRole("ProjectManager") && await _projectService.IsUserOnProject(user.Id, ticket.ProjectId) ||
                                  User.IsInRole("Developer") && ticket.DeveloperUserId == user.Id ||
                                  User.IsInRole("Submitter") && ticket.OwnerUserId == user.Id)
                                        {
                                            <a asp-controller="Tickets" asp-action="Edit" asp-route-id="@ticket.Id" class="btn btn-outline-dark text-white">Edit</a>}
                                        @if (User.IsInRole("Admin"))
                                        {
                                            <a asp-controller="Tickets" asp-action="Delete" asp-route-id="@ticket.Id" class="btn btn-outline-dark text-white">Delete</a>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="row ml-1 mr-1 mb-5">
                <div class="col-md widget p-5">
                    <div class="widget-heading">
                        <h3 class="mb-4">Tickets I've submitted</h3>
                    </div>
                    <table class="table table-striped table-responsive ticketsIndex">
                        <thead>

                            <tr>
                                <th>
                                    Title
                                </th>
                                <th>
                                    Description
                                </th>
                                <th>
                                    Created
                                </th>
                                <th>
                                    Updated
                                </th>
                                <th>
                                    Project
                                </th>
                                <th>
                                    Type
                                </th>
                                <th>
                                    Priority
                                </th>
                                <th>
                                    Status
                                </th>
                                <th>
                                    Creator
                                </th>
                                <th>
                                    Developer
                                </th>
                                <th>
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var ticket in Model.TicketsCreatedByMe)
                            {
                                <tr>
                                    <td>
                                        @ticket.Title
                                    </td>
                                    <td>
                                        @Html.Raw(ticket.Description)
                                    </td>
                                    <td>
                                        @ticket.Created
                                    </td>
                                    <td>
                                        @ticket.Updated
                                    </td>
                                    <td>
                                        @ticket.Project.Name
                                    </td>
                                    <td>
                                        @ticket.TicketType.Name
                                    </td>
                                    <td>
                                        @ticket.TicketPriority.Name
                                    </td>
                                    <td>
                                        @ticket.TicketStatus.Name
                                    </td>
                                    <td>
                                        @ticket.OwnerUser.FullName
                                    </td>
                                    <td>
                                        @if (ticket.DeveloperUserId == null)
                                        {
                                            <p>Unassigned</p>
                                        }
                                        else
                                        {
                                            @Html.DisplayFor(modelItem => ticket.DeveloperUser.FullName)
                                        }
                                    </td>
                                    <td>
                                        <a asp-controller="Tickets" asp-action="Details" asp-route-id="@ticket.Id" class="btn btn-outline-dark text-white">Details</a>
                                        @if (User.IsInRole("Admin") ||
                                  User.IsInRole("ProjectManager") && await _projectService.IsUserOnProject(user.Id, ticket.ProjectId) ||
                                  User.IsInRole("Developer") && ticket.DeveloperUserId == user.Id ||
                                  User.IsInRole("Submitter") && ticket.OwnerUserId == user.Id)
                                        {
                                            <a asp-controller="Tickets" asp-action="Edit" asp-route-id="@ticket.Id" class="btn btn-outline-dark text-white">Edit</a>}
                                        @if (User.IsInRole("Admin"))
                                        {
                                            <a asp-controller="Tickets" asp-action="Delete" asp-route-id="@ticket.Id" class="btn btn-outline-dark text-white">Delete</a>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }

        @if (User.IsInRole("NewUser"))
        {
            <div class="row ml-1 mr-1 mb-5">
                <div class="col-md widget p-5">
                    <div class="widget-heading">
                        <h3 class="mb-4">All Tickets</h3>
                    </div>
                    <table class="table table-striped table-responsive ticketsIndex">
                        <thead>

                            <tr>
                                <th>
                                    Title
                                </th>
                                <th>
                                    Description
                                </th>
                                <th>
                                    Created
                                </th>
                                <th>
                                    Updated
                                </th>
                                <th>
                                    Project
                                </th>
                                <th>
                                    Type
                                </th>
                                <th>
                                    Priority
                                </th>
                                <th>
                                    Status
                                </th>
                                <th>
                                    Creator
                                </th>
                                <th>
                                    Developer
                                </th>
                                <th>
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var ticket in Model.Tickets)
                            {
                                <tr>
                                    <td>
                                        @ticket.Title
                                    </td>
                                    <td>
                                        @Html.Raw(ticket.Description)
                                    </td>
                                    <td>
                                        @ticket.Created
                                    </td>
                                    <td>
                                        @ticket.Updated
                                    </td>
                                    <td>
                                        @ticket.Project.Name
                                    </td>
                                    <td>
                                        @ticket.TicketType.Name
                                    </td>
                                    <td>
                                        @ticket.TicketPriority.Name
                                    </td>
                                    <td>
                                        @ticket.TicketStatus.Name
                                    </td>
                                    <td>
                                        @ticket.OwnerUser.FullName
                                    </td>
                                    <td>
                                        @if (ticket.DeveloperUserId == null)
                                        {
                                            <p>Unassigned</p>
                                        }
                                        else
                                        {
                                            @Html.DisplayFor(modelItem => ticket.DeveloperUser.FullName)
                                        }
                                    </td>
                                    <td>
                                        <a asp-controller="Tickets" asp-action="Details" asp-route-id="@ticket.Id" class="btn btn-outline-dark text-white">Details</a>
                                        @if (User.IsInRole("Admin") ||
                                  User.IsInRole("ProjectManager") && await _projectService.IsUserOnProject(user.Id, ticket.ProjectId) ||
                                  User.IsInRole("Developer") && ticket.DeveloperUserId == user.Id ||
                                  User.IsInRole("Submitter") && ticket.OwnerUserId == user.Id)
                                        {
                                            <a asp-controller="Tickets" asp-action="Edit" asp-route-id="@ticket.Id" class="btn btn-outline-dark text-white">Edit</a>}
                                        @if (User.IsInRole("Admin"))
                                        {
                                            <a asp-controller="Tickets" asp-action="Delete" asp-route-id="@ticket.Id" class="btn btn-outline-dark text-white">Delete</a>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
    </div>
</div>